<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ã‚¹ã‚­ãƒã‚§ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¶ãƒ»ã‚²ãƒ¼ãƒ </title> 
<style>
  :root{ --bg:#0f1115; --fg:#eaeef2; }
  html,body{
    margin:0;height:100%;
    background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overscroll-behavior:none;touch-action:none;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
  }
  header.title{width:100%;display:flex;justify-content:center;align-items:center;
    padding:8px 6px;margin:0;background:#0b1220;border-bottom:1px solid #1f2b3a}
  header.title h1{margin:0;font-size:clamp(18px,4.3vw,24px);font-weight:900;color:#9bd5ff}

  .wrap{min-height:calc(100dvh - 48px);display:flex;flex-direction:column;align-items:center;gap:4px;padding:4px 6px 2px}
  .board{width:100%;max-width:720px;position:relative}
  #cv{width:100%;height:100%;display:block;background:#0b0e13;border-radius:12px}

  #muteBtn{
    position:absolute;top:6px;left:6px;z-index:5;
    width:40px;height:40px;font-size:20px;line-height:1;text-align:center;
    border-radius:8px;border:1px solid #26303a;background:#1f2937;color:#eaeef2;cursor:pointer;
  }

  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:3;font-weight:900;
    font-size:clamp(26px,7.5vw,52px);background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(1px);text-align:center}
  .overlay.show{display:flex}
  .overlay .ovtxt { display:inline-block; transform: translateY(30%); color: yellow; }

  .welcome{position:absolute;inset:0;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;z-index:2;
    text-align:center;background:rgba(0,0,0,.25)}
  .welcome h2{margin:0;font-size:clamp(24px,7vw,43px);font-weight:900;color:#c8ffe0;transform: translateY(50%);} 

  .tap-row{width:100%;max-width:820px;margin-top:2px;display:flex;justify-content:center}
  #tapBtn{
    width:min(92%,620px);height:92px;margin-bottom:10px;
    border:2px solid #334155;border-radius:16px;background:#0f131a;
    font-weight:900;font-size:clamp(20px,6vw,30px);color:#e5e7eb;cursor:pointer;-webkit-tap-highlight-color:transparent;
  }
  #tapBtn[disabled]{opacity:.45;cursor:not-allowed}

  .bar, #lullabyWrap{
    width:min(92%,620px);
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    justify-content:center;
    align-items:stretch;
  }
  .btn{
    border:1px solid #26303a;background:#1f2937;color:#fff;border-radius:12px;
    padding:10px 12px;
    font-weight:900;font-size:clamp(18px,5vw,24px);
    cursor:pointer;width:100%;
  }
  #startBtn{background:#10b981;border-color:#065f46;color:#062e26}

  /* ãƒ©ãƒ©ãƒã‚¤ */
  #lullabyBtn{display:none;background:#a855f7;border-color:#6d28d9}
  #rankLullabyBtn{display:none}

  dialog{border:none;border-radius:12px;padding:0;max-width:520px;width:90vw;background:#0f111a;color:#fff}
  .dlg-head{padding:12px 14px;border-bottom:1px solid #253040;font-weight:700}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
</style>
</head>
<body>
  <header class="title" id="hdr"><h1>ã‚¹ã‚­ãƒã‚§ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¶ãƒ»ã‚²ãƒ¼ãƒ </h1></header> 

  <div class="wrap">
    <div class="board" id="board">
      <canvas id="cv"></canvas>
      <button id="muteBtn" aria-label="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿">ğŸ”Š</button>
      <div id="welcome" class="welcome"><h2>ç›®æŒ‡ã›ã‚°ãƒ¬ã‚¤ãƒˆ10é€£ç¶šï¼</h2></div>
      <div id="overlay" class="overlay"><div class="ovtxt"></div></div>
    </div>

    <div class="tap-row" id="tapRow"><button id="tapBtn" disabled>TAP</button></div>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆï¼‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé€šå¸¸ï¼‰ -->
    <div class="bar" id="btnBar">
      <button id="startBtn" class="btn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="rankNormalBtn" class="btn">ğŸ† é€šå¸¸</button>
    </div>

    <!-- ãƒ©ãƒ©ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰ï¼‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ©ãƒ©ãƒã‚¤ï¼‰ -->
    <div id="lullabyWrap">
      <button id="lullabyBtn" class="btn">ãƒ©ãƒ©ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰</button>
      <button id="rankLullabyBtn" class="btn">ğŸ† ãƒ©ãƒ©ãƒã‚¤</button>
    </div>
  </div>

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
  <dialog id="rankDlg">
    <div class="dlg-head" id="rankTitle">ğŸ† è‡ªå·±ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP5ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰</div>
    <div class="dlg-body">
      <table class="rank-list"><thead><tr><th>#</th><th>æ—¥ä»˜</th><th>é€£ç¶šã‚°ãƒ¬ã‚¤ãƒˆæ•°</th></tr></thead><tbody id="rankTbody"></tbody></table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin:10px 14px 14px"><button id="closeRank" class="btn">é–‰ã˜ã‚‹</button></div>
    </div>
  </dialog>

<script>
(() => {
  // ===== è¨­å®š =====
  const CONFIG = {
    RPM: 60,                       // é‡ã®å›è»¢é€Ÿåº¦
    COUNTDOWN_MS: 1200,

    GOOD_RATIO  : 0.20,            // Good å¹…ï¼ˆå††å‘¨æ¯”ï¼‰
    GREAT_RATIO : 0.038,           // Great å¹…ï¼ˆå††å‘¨æ¯”ï¼‰ 

    // 5æ™‚ï½10æ™‚ï¼ˆ0=3æ™‚ã€è§’åº¦å¢—åŠ ï¼æ™‚è¨ˆå›ã‚Šï¼‰
    GREAT_CENTER_MIN_DEG: 70,
    GREAT_CENTER_MAX_DEG: 240,

    INPUT_CD_MS: 45,
    UNLOCK_STREAK: 10,             // 10é€£ç¶šã§ãƒ©ãƒ©ãƒã‚¤è§£æ”¾

    SUCCESS_PAUSE_MS: 1300,        // æˆåŠŸå¾Œâ†’æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰å¾…æ©Ÿï¼š1.3s
    SUCCESS_FREEZE_VISIBLE_MS: 300,// æˆåŠŸç›´å¾Œã®é™æ­¢è¡¨ç¤ºï¼š0.3sï¼ˆé‡ï¼†ã‚¾ãƒ¼ãƒ³è¦‹ã›ãŸã¾ã¾ï¼‰
    SHOW_DELAY_AFTER_KAN_MS: 400,  // é€šå¸¸ï¼ška-nâ†’0.4så¾Œã«å†è¡¨ç¤º
    LULLABY_MIN_DELAY_MS: 400,     // ãƒ©ãƒ©ãƒã‚¤ï¼š0.4ã€œ1.3ç§’
    LULLABY_MAX_DELAY_MS: 1300,

    // ãŠã¾ã‘ã‚°ãƒ¬ã‚¤ãƒˆè¨±å®¹è§’ï¼ˆGreatçµ‚ç«¯ã‚’æ™‚è¨ˆå›ã‚Šã«è¶…ãˆãŸåˆ†ã€åº¦ï¼‰â†å°‘ã—ç‹­ã
    GREAT_OVERSHOOT_GRACE_DEG: 4
  };

  // ===== è¦ç´  =====
  const $=id=>document.getElementById(id);
  const hdr=$('hdr'), board=$('board'), cv=$('cv'), ctx=cv.getContext('2d',{alpha:false,desynchronized:true});
  const tapRow=$('tapRow'), btnBar=$('btnBar'), lullabyWrap=$('lullabyWrap');
  const tapBtn=$('tapBtn'), startBtn=$('startBtn'), lullabyBtn=$('lullabyBtn');
  const rankNormalBtn=$('rankNormalBtn'), rankLullabyBtn=$('rankLullabyBtn');
  const muteBtn=$('muteBtn'), overlay=$('overlay'), welcome=$('welcome');
  const rankDlg=$('rankDlg'), rankTbody=$('rankTbody'), rankTitle=$('rankTitle'), closeRank=$('closeRank');

  // ===== çŠ¶æ…‹ =====
  let phase='idle';            // 'idle' | 'countdown' | 'play' | 'pause'
  let streak=0, lastInputAt=0, rafId=0, isMuted=false;
  let mode='normal';           // 'normal' | 'lullaby'
  let isEnding=false;          // é‡è¤‡çµ‚äº†ã‚¬ãƒ¼ãƒ‰

  const FULL=Math.PI*2;

  // æ™‚è¨ˆå›ã‚Šï¼šè§’åº¦â€œå¢—åŠ â€ã§é€²è¡Œã€‚åŸºæº–è§’ã¯12æ™‚ï¼ˆ-Ï€/2ï¼‰
  let baseAngle=-Math.PI/2;
  let baseTime=0;
  let frozenAngle=-Math.PI/2;

  // ã‚¾ãƒ¼ãƒ³ï¼ˆæ™‚è¨ˆå›ã‚Šã« startâ†’end ã§å®šç¾©ï¼‰
  let goodStart=0, goodEnd=0;
  let greatStart=0, greatEnd=0;  // Great ã¯ Good ã®ã€Œé€²å…¥å´=å³ç«¯ï¼ˆå…ˆé ­ï¼‰ã€ã«æ¥ã™ã‚‹ â†’ greatStart=goodStart

  // è¡¨ç¤ºåˆ¶å¾¡
  let showNeedle=false, showZones=true;

  // é€šéåˆ¤å®š
  let lastAngle=null;
  let startedGuard=false;        // é–‹å§‹ç›´å¾Œ1ãƒ•ãƒ¬ãƒ¼ãƒ ã¯é€šéåˆ¤å®šã‚’ç„¡åŠ¹åŒ–
  const EPS=1e-4;

  // æˆåŠŸæ™‚ã®è¡¨ç¤ºåˆ¶å¾¡
  let lastSuccessAngle = null;       // å®Ÿéš›ã«æ­¢ã‚ãŸè§’åº¦
  let lastSuccessWasGrace = false;   // ãŠã¾ã‘ã‚°ãƒ¬ã‚¤ãƒˆã ã£ãŸã‹

  // ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ =====
  function visualH(){ return (window.visualViewport?.height) || window.innerHeight; }
  function fitBoardToViewport(){
    const vh=visualH(), headH=hdr.offsetHeight, tapH=tapRow.offsetHeight, barH=btnBar.offsetHeight;
    const lullH=(lullabyWrap.offsetHeight||0) * ((lullabyBtn.style.display!=='none'||rankLullabyBtn.style.display!=='none')?1:0);
    const reserve=headH+tapH+barH+lullH+12;
    const idealSide=Math.min(board.clientWidth||board.getBoundingClientRect().width||320, Math.max(160, vh-reserve));
    board.style.height=idealSide+'px';
  }
  let cssW=0, cssH=0, dpr=1;
  function resizeCanvas(){
    fitBoardToViewport();
    const rect=cv.getBoundingClientRect();
    dpr=Math.max(1, Math.min(3, window.devicePixelRatio||1));
    cssW=rect.width||300; cssH=rect.height||300;
    cv.width=Math.round(cssW*dpr); cv.height=Math.round(cssH*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw(getCurrentAngle(performance.now()));
  }
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', resizeCanvas);
  window.visualViewport?.addEventListener('resize', resizeCanvas);
  requestAnimationFrame(resizeCanvas);

  // ===== ã‚µã‚¦ãƒ³ãƒ‰ =====
  const AudioCtx=window.AudioContext||window.webkitAudioContext;
  let actx=null,gMaster=null;

const SOUND_FILES = {
  tap   : 'tap.mp3',
  ready : 'ready.mp3',
  ka_n  : 'ka-n.mp3',
  batu  : 'batu.mp3',
  ex    : 'ex.mp3',
  fanfare: 'fanfare.mp3',
  cong  : 'cong.mp3',          // â† ã“ã‚Œã‚’è¿½åŠ 
};
  const buf={}; const html={};
  Object.entries(SOUND_FILES).forEach(([key, file])=>{
    const a=new Audio(file); a.preload='auto'; a.playsInline=true; html[key]=a; buf[key]=null;
  });

  async function unlockAndWarmAudio(){
    try{
      if(!actx){ actx=new AudioCtx({latencyHint:'interactive'}); gMaster=actx.createGain(); gMaster.gain.value=isMuted?0:1; gMaster.connect(actx.destination); }
      if(actx.state==='suspended') await actx.resume();
      await Promise.all(Object.entries(SOUND_FILES).map(async ([key,file])=>{
        if(buf[key]) return;
        const res=await fetch(file); const ab=await res.arrayBuffer(); buf[key]=await actx.decodeAudioData(ab);
      }));
    }catch{}
  }
  function setMuted(m){ isMuted=m; if(gMaster) gMaster.gain.value=m?0:1; Object.values(html).forEach(a=>a.muted=m); muteBtn.textContent=m?'ğŸ”‡':'ğŸ”Š'; }
  function playBuf(key,gain=0.95){ try{ if(!actx||!buf[key]) return false; const src=actx.createBufferSource(); const g=actx.createGain(); g.gain.value=gain; src.buffer=buf[key]; src.connect(g).connect(gMaster||actx.destination); src.start(); return true;}catch{return false} }
  function playSE(key){ if(isMuted) return; if(playBuf(key)) return; unlockAndWarmAudio(); const tag=html[key]; if(tag){ try{ tag.currentTime=0; tag.play(); }catch{} } }
  window.addEventListener('pointerdown', ()=>{ unlockAndWarmAudio(); }, {once:true});

  // ===== è§’åº¦ï¼æç”» =====
  const norm=a=>(a%FULL+FULL)%FULL;
  const cwDelta=(from,to)=> (to - from + FULL) % FULL; // æ™‚è¨ˆå›ã‚Šé‡

  const angleAt = t => {
    const rps = CONFIG.RPM / 60;
    const d = (t - baseTime) / 1000;
    return norm(baseAngle + rps * FULL * d); // æ™‚è¨ˆå›ã‚Š
  };
  const getCurrentAngle=t=>(phase==='play')?angleAt(t):frozenAngle;

  function draw(angle){
    const w=cssW,h=cssH,CX=w/2,CY=h/2, r=Math.min(w,h)*0.42;
    ctx.clearRect(0,0,w,h);

    // å¤–æ 
    ctx.beginPath(); ctx.arc(CX,CY,r,0,FULL); ctx.lineWidth=2; ctx.strokeStyle='#1a2330'; ctx.stroke();

    // ã‚¾ãƒ¼ãƒ³ï¼ˆGoodâ†’Greatï¼‰
    if(showZones){
      ctx.beginPath();
      ctx.lineWidth=24; ctx.strokeStyle='#94a3b8';
      ctx.arc(CX,CY,r,goodStart,goodEnd); ctx.stroke();

      ctx.beginPath();
      ctx.lineWidth=24; ctx.strokeStyle='#ffffff';
      ctx.arc(CX,CY,r,greatStart,greatEnd); ctx.stroke();
    }

    // é‡
    if(showNeedle){
      const fx=CX + r*1.2*Math.cos(angle);
      const fy=CY + r*1.2*Math.sin(angle);
      ctx.beginPath(); ctx.moveTo(CX,CY); ctx.lineTo(fx,fy);
      ctx.lineWidth=6; ctx.lineCap='butt'; ctx.strokeStyle='#ef4444'; ctx.stroke();
    }

    // é€£ç¶šè¡¨ç¤ºï¼ˆâ˜…ãƒ•ã‚©ãƒ³ãƒˆ1.2å€ï¼‰
    const combo=String(streak);
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`900 ${Math.max(18,Math.round(r*0.32*1.2))}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif`;
    ctx.lineWidth=Math.max(2,Math.round(r*0.04)); 
    ctx.strokeStyle='rgba(0,0,0,0.55)'; ctx.strokeText(combo,CX,CY-r*0.18);
    ctx.fillStyle='#eaeef2'; ctx.fillText(combo,CX,CY-r*0.18); ctx.restore();
  }

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function deg2rad(d){ return d*Math.PI/180; }
  function setNeedleAt12(now){
    baseTime=now;
    baseAngle = -Math.PI/2; // 12æ™‚
    frozenAngle = -Math.PI/2;
    lastAngle = baseAngle;
  }
  function randomIn(min,max){ return min + Math.random()*(max-min); }

  // è¡¨ç¤ºç”¨ï¼šè§’åº¦ a ã‚’æ™‚è¨ˆå›ã‚Šå¼§ sâ†’e å†…ã«ã‚¯ãƒ©ãƒ³ãƒ—ï¼ˆå¿…è¦ãªã¨ãã ã‘ä½¿ç”¨ï¼‰
  function clampAngleToArc(a, s, e){
    let ss = s, ee = e, aa = a;
    if (ee < ss) ee += FULL;
    while (aa < ss) aa += FULL;
    while (aa > ee) aa -= FULL;
    if (aa < ss) aa = ss;
    if (aa > ee) aa = ee;
    return norm(aa);
  }

  // 5ï½10æ™‚ãƒ¬ãƒ³ã‚¸ã« Good ã‚’ç½®ã â†’ Great ã¯ Good ã®ã€Œé€²å…¥å´ï¼å³ç«¯ï¼ˆå…ˆé ­ï¼‰ã€ã«æ¥ã™ã‚‹
  function placeZones(){
    const goodW  = FULL * CONFIG.GOOD_RATIO;
    const greatW = FULL * CONFIG.GREAT_RATIO;

    const cdeg = randomIn(CONFIG.GREAT_CENTER_MIN_DEG, CONFIG.GREAT_CENTER_MAX_DEG);
    const c = norm(deg2rad(cdeg)); // ä¸­å¿ƒè§’

    const bStart = norm(c - goodW/2);
    const bEnd   = norm(c + goodW/2);

    const gStart = bStart;             // é€²å…¥å´ï¼ˆå…ˆé ­ï¼‰
    const gEnd   = norm(gStart + greatW);

    goodStart=bStart; goodEnd=bEnd;
    greatStart=gStart; greatEnd=gEnd;
  }

  // è§’åº¦ a ãŒã€Œæ™‚è¨ˆå›ã‚Šã®å¼§ sâ†’eã€ã«å«ã¾ã‚Œã‚‹ã‹
  function inArcCW(a,s,e){ return (s<=e) ? (a>=s && a<=e) : (a>=s || a<=e); }

  // â€œãŠã¾ã‘ã‚°ãƒ¬ã‚¤ãƒˆâ€åˆ¤å®šï¼ˆGreatçµ‚ç«¯ã‚’å°‘ã—æ™‚è¨ˆå›ã‚Šã«è¶…ãˆã¦ã„ã‚‹ã‹ï¼‰
  function isGraceGreat(a){
    const grace = deg2rad(CONFIG.GREAT_OVERSHOOT_GRACE_DEG);
    if (inArcCW(a, greatStart, greatEnd)) return false; // æ—¢ã«Greatå†…ã¯é€šå¸¸æˆåŠŸ
    const over = cwDelta(greatEnd, a);                  // greatEndâ†’a ã®æ™‚è¨ˆå›ã‚Šå·®
    return over > 0 && over <= grace;                   // greatEndç›´å¾Œï¼ˆ= Goodå´ï¼‰ã ã‘ãŠã¾ã‘
  }

  // ===== ãƒ«ãƒ¼ãƒ—ï¼ˆâ€œæœ€åˆã«ã‚°ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³ã‚’é€šã‚Šè¶Šã—ãŸâ€ç¬é–“ã«ãƒŸã‚¹ï¼‰ =====
  function loop(now){
    const ang=getCurrentAngle(now);
    draw(ang);

    if(phase==='play' && lastAngle!=null){
      if (startedGuard){
        startedGuard=false;
      } else {
        const movedCW = cwDelta(lastAngle, ang);
        const toGoodEnd = cwDelta(lastAngle, goodEnd);
        if (movedCW > EPS && toGoodEnd > EPS && movedCW > toGoodEnd){
          gameOver('ex'); // ä½•ã‚‚æŠ¼ã•ãšã«Goodã‚’é€šé
          return;
        }
      }
    }
    lastAngle=ang;
    rafId=requestAnimationFrame(loop);
  }

  // ===== å…¥åŠ›åˆ¤å®š =====
  function tapTimestamp(e){
    const ts=(e&&typeof e.timeStamp==='number')?e.timeStamp:performance.now();
    return (Math.abs(ts - performance.now()) < 10000) ? ts : performance.now();
  }

  // ===== ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ =====
  function setupInitial(){
    placeZones();
    resizeCanvas();
    lastSuccessAngle = null;
    lastSuccessWasGrace = false;
  }

  function showCountdown(){
    overlay.classList.add('show');
    const ov=overlay.querySelector('.ovtxt');
    ov.style.transform='translateY(30%)'; // æ—¢å®šä½ç½®
    ov.style.color='yellow';
    ov.textContent='Ready';

    tapBtn.disabled=true; phase='countdown';
    showNeedle=false; showZones=true; draw(frozenAngle);

    const t0=performance.now(), mid=t0+CONFIG.COUNTDOWN_MS*0.6, end=t0+CONFIG.COUNTDOWN_MS;
    const tick=()=>{
      const now=performance.now();
      if(now>=end){
        overlay.classList.remove('show');
        ov.textContent='';
        phase='pause';
        const startAfter = ()=>{
          const t=performance.now();
          setNeedleAt12(t);
          showNeedle=true; showZones=true; draw(frozenAngle);
          startedGuard=true;
          phase='play';
          tapBtn.disabled=false;
        };
        if(mode==='normal'){
          playSE('ka_n');
          setTimeout(startAfter, CONFIG.SHOW_DELAY_AFTER_KAN_MS);
        }else{
          const rnd = Math.round(randomIn(CONFIG.LULLABY_MIN_DELAY_MS, CONFIG.LULLABY_MAX_DELAY_MS));
          setTimeout(startAfter, rnd);
        }
        return;
      }
      if(now>=mid){
        ov.textContent='GO!';
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  function startGame(which){
    mode=which;
    isEnding=false;
    welcome.style.display='none';
    playSE('ready'); unlockAndWarmAudio();
    if(rafId) cancelAnimationFrame(rafId);
    streak=0;
    showNeedle=false; showZones=true;
    setupInitial();
    showCountdown();
    rafId=requestAnimationFrame(loop);
  }

  // æˆåŠŸå¾Œï¼ˆGreatï¼‰â†’ æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰æº–å‚™
  function endRoundAndQueueNext(){
    phase='pause';

    // ã€Œã‚°ãƒ¬ã‚¤ãƒˆï¼ã€ï¼ˆé€šå¸¸ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½ç½®ã§OKï¼‰
    overlay.classList.add('show');
    const ov=overlay.querySelector('.ovtxt');
    ov.style.transform='translateY(30%)';
    ov.style.color='yellow';
    ov.textContent='ã‚°ãƒ¬ã‚¤ãƒˆï¼';

    // ãƒ•ãƒªãƒ¼ã‚ºä¸­ã®é‡è¡¨ç¤ºï¼šé€šå¸¸ã¯æ­¢ã‚ãŸè§’åº¦ï¼ãŠã¾ã‘ã ã‘å¢ƒç›®ã¸å¸ç€
    const now = performance.now();
    const curAngle = angleAt(now);
    const displayAngle =
      (lastSuccessWasGrace ? norm(greatEnd) : (lastSuccessAngle ?? curAngle));

    frozenAngle = displayAngle;
    showNeedle = true;
    showZones  = true;
    draw(frozenAngle);

    const freeze = CONFIG.SUCCESS_FREEZE_VISIBLE_MS;
    const remain = Math.max(0, CONFIG.SUCCESS_PAUSE_MS - freeze);

    setTimeout(()=>{
      showNeedle=false;
      showZones=false;
      draw(frozenAngle);

      placeZones();

      setTimeout(()=>{
        overlay.classList.remove('show');
        ov.textContent='';

        if(mode==='normal'){ playSE('ka_n'); }
        const extra = (mode==='normal')
          ? CONFIG.SHOW_DELAY_AFTER_KAN_MS
          : Math.round(randomIn(CONFIG.LULLABY_MIN_DELAY_MS, CONFIG.LULLABY_MAX_DELAY_MS));

        setTimeout(()=>{
          const t=performance.now();
          setNeedleAt12(t);
          showNeedle=true;
          showZones=true;
          draw(frozenAngle);
          startedGuard=true;
          phase='play';
        }, extra);
      }, remain);
    }, freeze);
  }

  function onTap(e){
    if(phase!=='play' || isEnding) return;
    const now=tapTimestamp(e);
    if(now-lastInputAt<CONFIG.INPUT_CD_MS) return;
    lastInputAt=now;

    const a=angleAt(now);
    const inGreat = inArcCW(a, greatStart, greatEnd);
    const inGood  = inArcCW(a, goodStart,  goodEnd);
    const grace   = isGraceGreat(a);

    if (inGreat || grace) {
  playSE('tap');
  streak++;

  if (streak === CONFIG.UNLOCK_STREAK) {
    playSE('cong');          // â˜…10å›é”æˆã®ç¬é–“ã«é³´ã‚‰ã™ï¼ˆé€šå¸¸ãƒ»ãƒ©ãƒ©ãƒã‚¤å…±é€šï¼‰
    unlockLullaby();         // æ—¢å­˜å‡¦ç†ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã€ãƒ©ãƒ©ãƒã‚¤æ™‚ã¯æ—¢ã«1ã§ã‚‚OKï¼‰
  }

  lastSuccessAngle = a;
  lastSuccessWasGrace = !inGreat && grace;

  endRoundAndQueueNext();
}else if(inGood){
      gameOver('batu');
    }else{
      gameOver('ex');
    }
  }

  function gameOver(soundKey='batu'){
    if(isEnding) return;
    isEnding=true;

    if(soundKey){ playSE(soundKey); }

    stopGame(true);
    saveScore({score:streak, at:Date.now()});
    updateUnlockVisibility();

    overlay.classList.add('show');
    const ov = overlay.querySelector('.ovtxt');

    if (streak >= 10) {
      // 10å›é”æˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å††ä¸­å¿ƒã«2è¡Œã§è¡¨ç¤º
      ov.style.transform = 'translateY(0)';

      if (mode === 'lullaby') {
        // â˜…ãƒ©ãƒ©ãƒã‚¤æ™‚ã®ç‰¹åˆ¥æ–‡è¨€
        ov.innerHTML = '<span style="color:#ffffff">ãƒ©ãƒ©ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰ã§10å›é€£ç¶šã¯ç¥ã€‚</span><br><span style="color:yellow">ãœã²Xã§ã‚¹ã‚¯ã‚·ãƒ§ã‚’æŠ•ç¨¿ã—ã¦ã­ï¼</span>';
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®é”æˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå‰å›ä»•æ§˜ã‚’è¸è¥²ï¼‰
        ov.innerHTML = '<span style="color:#ffffff">10å›é”æˆãŠã‚ã§ã¨ã†ï¼ğŸ‰</span><br><span style="color:yellow">ãƒ©ãƒ©ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼</span>';
      }
    } else {
      // é€šå¸¸ã®å¤±æ•—è¡¨ç¤ºï¼ˆæ—¢å®šä½ç½®ã¸æˆ»ã™ï¼‰
      ov.style.transform = 'translateY(30%)';
      ov.style.color = '#ffffff';
      ov.textContent = 'å¤±æ•—';
    }
  }

  function stopGame(keepOverlay){
    phase='idle'; tapBtn.disabled=true;
    showNeedle=false;
    if(rafId) cancelAnimationFrame(rafId);
    if(!keepOverlay){ overlay.classList.remove('show'); overlay.querySelector('.ovtxt').textContent=''; }
    draw(frozenAngle);
  }

  // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚° =====
  const KEY_NORMAL='rank_great_normal_v6';
  const KEY_LULL  ='rank_great_lullaby_v6';
  function loadScores(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch{return []} }
  function saveScore(entry){
    if(entry.score<=0) return;
    const key=(mode==='lullaby')?KEY_LULL:KEY_NORMAL;
    const arr=loadScores(key); arr.push(entry);
    arr.sort((a,b)=> b.score-a.score || b.at-a.at);
    localStorage.setItem(key, JSON.stringify(arr.slice(0,5)));
  }
  function openRanking(which){
    const key=(which==='lullaby')?KEY_LULL:KEY_NORMAL;
    const arr=loadScores(key);
    rankTbody.innerHTML='';
    arr.forEach((e,i)=>{
      const d=new Date(e.at);
      const date=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${date}</td><td>${e.score}</td>`;
      rankTbody.appendChild(tr);
    });
    rankTitle.textContent=(which==='lullaby')?'ğŸ† è‡ªå·±ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP5ï¼ˆãƒ©ãƒ©ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰ï¼‰':'ğŸ† è‡ªå·±ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP5ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰';
    rankDlg.showModal();
  }

  // ===== ãƒ©ãƒ©ãƒã‚¤è§£æ”¾ =====
  const UNLOCK_KEY='unlock_lullaby_mode';
  function isUnlocked(){ try{ return localStorage.getItem(UNLOCK_KEY)==='1'; }catch{ return false; } }
  function unlockLullaby(){ try{ localStorage.setItem(UNLOCK_KEY,'1'); }catch{} updateUnlockVisibility(); }

  function updateUnlockVisibility(){
    const unlocked=isUnlocked();
    lullabyBtn.style.display = unlocked ? 'inline-block' : 'none';
    rankLullabyBtn.style.display = unlocked ? 'inline-block' : 'none';
    requestAnimationFrame(resizeCanvas);
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
  startBtn.addEventListener('click', e=>{ e.preventDefault(); startGame('normal'); }, {passive:false});
  lullabyBtn.addEventListener('click', e=>{ e.preventDefault(); startGame('lullaby'); }, {passive:false});
  tapBtn  .addEventListener('pointerdown', e=>{ e.preventDefault(); onTap(e); }, {passive:false});
  window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); onTap(e); } });

  muteBtn.addEventListener('click', e=>{ e.preventDefault(); setMuted(!isMuted); }, {passive:false});
  $('rankNormalBtn').addEventListener('click', e=>{ e.preventDefault(); openRanking('normal'); }, {passive:false});
  $('rankLullabyBtn')   .addEventListener('click', e=>{ e.preventDefault(); openRanking('lullaby'); }, {passive:false});
  $('closeRank')        .addEventListener('click', e=>{ e.preventDefault(); rankDlg.close(); }, {passive:false});

  // ===== åˆæœŸåŒ– =====
  setMuted(false);
  updateUnlockVisibility();
  requestAnimationFrame(()=>{ resizeCanvas(); });
})();
</script>
</body>
</html>
